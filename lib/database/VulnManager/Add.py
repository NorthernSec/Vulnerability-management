@cursor_wrapped
def addComponent(cur, component):
  cur.execute("""WITH s as (
                 SELECT id, name
                 FROM Components
                   WHERE name = %s
                 ), i AS (
                   INSERT INTO Components (name)
                   SELECT %s
                   WHERE NOT EXISTS (SELECT 1 FROM s)
                   RETURNING id, name
                 ) SELECT id, name FROM i
                 UNION ALL
                 SELECT id, name FROM s; """,(component, component))
  vmdb.commit()
  componentID=cur.fetchone()[0]
  return componentID

@cursor_wrapped
def addSystemGroup(cur, _group):
  if type(_group) is not SystemGroup: return False
  j=_group.getDict()
  try:
    groupID=cur.execute("""INSERT INTO System_Groups (name, team_id, info)
                             SELECT %s, id, %s
                               FROM Teams
                               WHERE name = %s
                             RETURNING id;""" , (j['groupName'], j['notes'], j['team']))
    for c in j["components"]:
      componentID=addComponent(c)
      try:
        cur.execute("""INSERT INTO Components_in_System_Group VALUES(%s, %s);""",(componentID, groupID))
      except:
        pass
    vmdb.commit()
    return groupID
  except Exception as e:
    print(traceback.format_exc())
    return None

@cursor_wrapped
def addTicket(cur, _ticket):
  if type(_ticket) is not Ticket: return False
  t=_ticket.getDict()
  try:
    cur.execute("""SELECT id FROM System_Groups WHERE name = %s AND team_id IN (SELECT id FROM Teams WHERE name = %s);""",(t["groupName"], t["team"]))
    sgid=cur.fetchone()[0]
    cur.execute("""SELECT id FROM Components WHERE name = %s;""",(t["vulnComp"]["cpe"],))
    cid=cur.fetchone()[0]
    cur.execute("""SELECT id FROM Teams WHERE name = %s;""",(t["team"],))
    tid=cur.fetchone()[0]
    priority = calculatePriority(t)
    info     = cvedb.getCVEInfo(t["cve"])
    cur.execute("""INSERT INTO Tickets VALUES (DEFAULT, %s, %s, %s, %s, %s, %s) RETURNING ID;""",(None, None, t["cve"], sgid, cid, tid))
    ticket_id=cur.fetchone()[0]
    cur.execute("""INSERT INTO Ticket_Histories(ticket_id, datetime, cvss, ticket_status_id, ticket_priority_id) VALUES(%s, %s, %s, %s, %s) RETURNING ID;""",
                (ticket_id, datetime.fromtimestamp(time.time()), info["cvss"], _DEFAULT_STATUS, priority))
    history=cur.fetchone()[0]
    cur.execute("""UPDATE Tickets SET history_created_id=%s, history_last_id=%s WHERE id=%s"""%(ticket_id, ticket_id, history))
    vmdb.commit()
    return ticket_id
  except Exception as e:
    print(traceback.format_exc())
    return None

@cursor_wrapped
def addUser(cur, _user):
  # TODO all user stuff
  u=_user.getDict();
  pwd=pbkdf2_sha256.encrypt(u["password"], rounds=rounds, salt_size=saltLength)
  try:
    groupID=cur.execute("""INSERT INTO Users VALUES(DEFAULT, %s, first_name, last_name, password);""" , (u['userID'], u['notes'], j['team']))
    return groupID
  except:
    return None
