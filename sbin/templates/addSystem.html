<script>
  // Add
  $(function() {
    if("{{group}}"){
      alert("{{group|safe}}");
      $("#name").val("{{group['groupName']}}");
      $("#notes").val("{{group['notes']}}");
    }
    $('#add').bind('click', function() {
      $('#componentlist option:selected').remove().appendTo('#components').removeAttr('selected');
      alphasort("#components");
    });
    $('#remove').bind('click', function() {
      $('#components option:selected').remove().appendTo('#componentlist').removeAttr('selected');
      alphasort("#componentlist");
    });
    $('#new').bind('click', function() {
      var cpe=$("#newCPE").val();
      if(/^(cpe\:2\.3\:[a|o|h]:.+:.+)$/.test(cpe)){
        $("#components").append('<option value="'+cpe+'">'+(cpe.split(":").slice(4, 6)).join(" ")+'</option>');
        alphasort("#components");
      }
    });
    $('#reset' ).bind('click', function() {$("#content").load("/_add_system_view");});
    $('#back'  ).bind('click', function() {$("#content").load("/_team_content", {team:"{{team}}"});});
    $('#commit').bind('click', function() {
      var opts = new Array;
      $("#components option").each(function(){
        opts.push($(this).text()+"|"+$(this).val());
      });
      name=$("#name").val().trim()
      if(name.length  != 0){
        $.getJSON('/_add_system', {
          team:"{{team}}", groupName:name, notes:$("#notes").val(), systems:$("#systems").val(), components:opts.join(',')
        }, function(data) {
          $("#systemContent").empty();
          line="";
          for (i=0;i<data["groups"].length;i++){
            line+="<b>"+data["groups"][i]['groupName']+"</b> - "+data["groups"][i]['systems'].length+" systems\n<ul>\n";
            for (j=0;j<data["groups"][i]['components'].length;j++){
              line+="<li>"+data["groups"][i]['components'][j]["name"]+"</li>";}
            line+="</ul>";
            $("#systemContent").append(line);
            line="";}
          showStatus(data);
          $("#content").load("/_team_content", {team:"{{team}}"});
        });
      }
    });
    {% for c in components %}
      $("#componentlist").append('<option value="{{c}}">'+("{{c|unescape}}".split(":").slice(4, 6)).join(" ")+'</option>');
    {% endfor %}
  });
</script>
<form onsubmit="/teams/{{team}}/systems/add">
  <table>
    <tr><td>Group name: </td> <td><input    type="text"        id="name" required></td></tr>
    <tr><td>Notes:      </td> <td><textarea rows="4" cols="50" id="notes"   placeholder="Notes"></textarea></td></tr>
    <tr><td>Systems:    </td> <td><textarea rows="4" cols="50" id="systems" placeholder="systems, separated by a semicolon (;)"></textarea></td></tr>
    <tr><td>Components: </td>
      <td>
        <table>
          <tr>
            <td>
              <select id="componentlist" size="12">
              </select>
            </td>
            <td>
              <table>
                <tr><td><button id="add"    type="button"><span class="glyphicon glyphicon-menu-right"></span></button></td></tr>
                <tr><td><button id="remove" type="button"><span class="glyphicon glyphicon-menu-left"></span></button></td></tr>
              </table>
            </td>
            <td>
              <select id="components" size="10"></select><br />
              <input id="newCPE" type="text" placeholder="new cpe"/>
              <button id="new" type="button"><span class="glyphicon glyphicon-plus"></span></button>
            </td>
          </tr>
        </table>
      </td>
    </tr>
  </table>
  <button id="commit" type="button">Create group</button> <button id="reset" type="button">Clear fields</button><br />
  <a id="back"><span class="glyphicon glyphicon-arrow-left">Back</span></a>
</form>
