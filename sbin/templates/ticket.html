<script>
  $(function() {
    var tNotes="{{ticket['notes']}}"
    var tStatus="{{ticket['status']}}"
    $("#statusses").val(tStatus);
    if("{{ticket['status']}}" != "{{statusses[0]}}"){
      alert("in");
      $("#statusses option[value='{{ticket['status']}}']").remove();
    }
    function fixNotes(){
      $('#notes').empty();
      $('#notes').append(tNotes);
    }
    $('#edit-notes').bind('click', function() {
      $('#notes').empty();
      $('#notes').append("<textarea rows='4' cols='50' id='taNotes'>"+tNotes+"</textarea><br/>");
      $('#notes').append("<button id='updateNotes' type='button'>Update</button>");
      $('#notes').append("<button id='cancelNotes' type='button'>Cancel</button>");
      $('#cancelNotes').bind('click', function() { fixNotes(); })
      $('#updateNotes').bind('click', function() {
        var notes=$('#taNotes').val();
        $.getJSON('/_set_ticket_notes', {
          team:"{{team}}", cve:"{{ticket['cve']['id']}}", system:"{{system}}", notes:notes
        }, function(data) {
          if(data["status"] == true){
            tNotes=notes
            fixNotes();
          }else{
            alert("an error occured");
          }
        })
      })
    });
    $('#editNotes').bind('click', function() {
      var status=$('#statusses').val();
      $.getJSON('/_set_ticket_status', {
        team:"{{team}}", cve:"{{ticket['cve']['id']}}", system:"{{system}}", status:status
      }, function(data) {
        if(data["status"] == true){
          tStatus=status;
          $("#tickstatus").text(tStatus);
        }else{
          alert("an error occured");
        }
      })
    });
  })
</script>

<p>
  <b><span>{{ticket['cve']['id']}} - CVSS: {{ticket['cve']['cvss']}} - <span id="tickstatus">{{ticket['status']}}</span></span></b><br />
  <span>{{ticket['cve']['summary']}}</span>
</p>

<div class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">Notes <span id="edit-notes" class="glyphicon glyphicon-pencil" aria-hidden="true"></span></h3>
  </div>
  <div id="notes" class="panel-body">
    {{ticket["notes"]}}
  </div>
</div>

<div class="panel panel-info">
  <div class="panel-heading">
    <h3 class="panel-title">Actions</h3>
  </div>
  <div class="panel-body">
    <select id="statusses">
      {% for s in statusses %}
        <option value="{{s}}">{{s}}</option>
      {% endfor %}
    </select>
    <button id="editNotes">Change status</button>
  </div>
</div>

