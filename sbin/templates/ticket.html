<script>
  $(function() {
    var tNotes="{{ticket['notes']|trim}}";
    var tStatus="{{ticket['status']|trim}}";
    $("#statusses").val(tStatus);
    if(tStatus != "{{statusses[0]}}"){ $("#statusses option[value='{{statusses[0]}}']").remove(); }
    
    function fixNotes(){  $('#notes').empty(); $('#notes').append(tNotes); }

    function setUpdate(cpe, updateType){
      alert("TODO");
      $.getJSON('/set_ticket_update', {
        id:"{{ticket['team']}}|{{ticket['groupName']}}|{{ticket['cve']['id']}}|{{ticket['vulnComp']['cpe']}}",
        cve:"{{ticket['cve']['id']}}", cpe:"{{ticket['vulnComp']['cpe']}}", newCPE: cpe, updateType:updateType
      }, function(data) {
        if(data["status"] == true){
          alert("done")
        }else{
          alert("an error occured");
        }
      })
    }

    $('#update').change(function() {
      $("#updateField").empty();
      var pack = ("{{ticket['vulnComp']['cpe']|trim}}".split(":").slice(0, 5)).join(":")
      var vers = ("{{ticket['vulnComp']['cpe']|trim}}".split(":").slice(5)).join(":")
      if($("#update").val()=="upgrade"){
        $("#updateField").append("Updated the package to version:<br />"+pack+":");
        $("#updateField").append("<input type='text' id='updatecpe' placeholder='"+vers+"'><button id='UpdatePackage' type='button'>Update</button><br /> <br />");
        $("#UpdatePackage").click(function (){ setUpdate($("#updatecpe").val(), "upgrade") })
      }else if($("#update").val()=="merge"){
        $("#updateField").append("Change package to:<br /><input type='text' id='updatecpe' size='35' placeholder='cpe:2.3:<type>:<vendor>:<software>'><button id='ChangePackage' type='button'>Update</button><br /> <br />");
        $("#ChangePackage").click(function (){ setUpdate($("#updatecpe").val(), "merge") })
      }else if($("#update").val()=="remove"){
        $("#updateField").append("<button id='RemovePackage'>Uninstall Package </button><span id='updatecpe'></span>");
        $("#RemovePackage").click(function (){ setUpdate($("#updatecpe").val(), "remove") })
      }
      if($("#update").val()=="{{ticket['vulnComp']['type']|safe}}"){$("#updatecpe").val("{{ticket['vulnComp']['update']|safe}}")}
      if("{{ticket['vulnComp']['type']|safe}}"=="remove"){$("#updatecpe").append(" * Currently selected");}
    });
    $("#statusses").change(function() {  if($("#statusses").val()==tStatus){$("#editStatus").prop('disabled', true);}else{$("#editStatus").prop('disabled', false);} });
    $('#edit-notes').bind('click', function() {
      $('#notes').empty();
      $('#notes').append("<textarea rows='4' cols='50' id='taNotes'>"+tNotes+"</textarea><br/>");
      $('#notes').append("<button id='updateNotes' type='button'>Update</button>");
      $('#notes').append("<button id='cancelNotes' type='button'>Cancel</button>");
      $('#cancelNotes').bind('click', function() { fixNotes(); })
      $('#updateNotes').bind('click', function() {
        var notes=$('#taNotes').val();
        $.getJSON('/_set_ticket_notes', {
          id:"{{ticket['team']}}|{{ticket['groupName']}}|{{ticket['cve']['id']}}|{{ticket['vulnComp']['cpe']}}", notes:notes
        }, function(data) {
          if(data["status"] == true){
            tNotes=notes
            fixNotes();
          }else{
            alert("an error occured");
          }
        })
      })
    });
    $('#editStatus').bind('click', function() {
      var status=$('#statusses').val();
      $.getJSON('/_set_ticket_status', {
        id:"{{ticket['team']}}|{{ticket['groupName']}}|{{ticket['cve']['id']}}|{{ticket['vulnComp']['cpe']}}", status:status
      }, function(data) {
        if(data["status"] == true){
          tStatus=status;
          $("#tickstatus").text(tStatus);
          $("#editStatus").prop('disabled', true);
          $("#statusses option[value='{{statusses[0]}}']").remove();
        }else{
          alert("an error occured");
        }
      })
    });
    {%if "type" in ticket['vulnComp']%}
      $("#update").val("{{ticket['vulnComp']['type']|safe}}");
      $("#update").trigger("change");
    {%endif%}
  })
</script>

<p>
  <b><span>{{ticket['cve']['id']}} - CVSS: {{ticket['cve']['cvss']}} - <span id="tickstatus">{{ticket['status']}}</span></span></b><br />
  <span>{{ticket['cve']['summary']}}</span>
</p>

<div class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">Notes <span id="edit-notes" class="glyphicon glyphicon-pencil" aria-hidden="true"></span></h3>
  </div>
  <div id="notes" class="panel-body">
    {{ticket["notes"]}}
  </div>
</div>

<div class="panel panel-info">
  <div class="panel-heading">
    <h3 class="panel-title">Actions</h3>
  </div>
  <div class="panel-body">
    <b>Set status</b><br />
    <select id="statusses">
      {% for s in statusses %}
        <option value="{{s}}">{{s}}</option>
      {% endfor %}
    </select>
    <button id="editStatus" disabled>Change status</button><br /><br />
    <b>Update requirements</b><br />
    
    <select id='update'>
      <option value=' - '> - </option>
      <option value='upgrade'>Upgrade</option>
      <option value='merge'>Merge</option>
      <option value='remove'>Uninstall</option>
    </select>
    <div id="updateField"></div>
  </div>
</div>

