<script>
  $(function() {
    var tNotes="{{ticket['notes']|trim}}";
    var tStatus="{{ticket['status']|trim}}";
    $("#statusses").val(tStatus);
    if(tStatus != "{{statusses[0]}}"){ $("#statusses option[value='{{statusses[0]}}']").remove(); }
    setUpdate();
    
    function fixNotes(){
      $('#notes').empty();
      $('#notes').append(tNotes);
    }
    function setUpdate(){
      $("#update").empty();
      if(tStatus != "{{statusses[0]}}"){
        {% for x in components %}
          var pack = ("{{x['cpe']}}".split(":").slice(0, 5)).join(":")
          var vers = ("{{x['cpe']}}".split(":").slice(5)).join(":")
          $("#update").append("Updated the package to version:<br />"+pack+":");
          $("#update").append("<input type='text' id='updatecpe{{loop.index}}' placeholder='"+vers+"'><button id='UpdatePackage{{loop.index}}' type='button'>Update</button><br /> <br />");
          $("#update").append("Change package to:<br /><input type='text' id='updatecpe{{loop.index}}' size='35' placeholder='cpe:2.3:<type>:<vendor>:<software>'><button id='ChangePackage{{loop.index}}' type='button'>Update</button><br /> <br />");
          $("#update").append("Uninstall Package: <br /><button id='RemovePackage{{loop.index}}'>Uninstall Package </button>");
          $("#UpdatePackage{{loop.index}}").bind('click', function(){ 
            alert("Test");
          })
        {% endfor %}
      }
    }
    $("#statusses").change(function() {
      if($("#statusses").val()==tStatus){$("#editStatus").prop('disabled', true);}else{$("#editStatus").prop('disabled', false);}
      setUpdate();
    });
    $('#edit-notes').bind('click', function() {
      $('#notes').empty();
      $('#notes').append("<textarea rows='4' cols='50' id='taNotes'>"+tNotes+"</textarea><br/>");
      $('#notes').append("<button id='updateNotes' type='button'>Update</button>");
      $('#notes').append("<button id='cancelNotes' type='button'>Cancel</button>");
      $('#cancelNotes').bind('click', function() { fixNotes(); })
      $('#updateNotes').bind('click', function() {
        var notes=$('#taNotes').val();
        $.getJSON('/_set_ticket_notes', {
          team:"{{team}}", cve:"{{ticket['cve']['id']}}", system:"{{system}}", notes:notes
        }, function(data) {
          if(data["status"] == true){
            tNotes=notes
            fixNotes();
          }else{
            alert("an error occured");
          }
        })
      })
    });
    $('#editStatus').bind('click', function() {
      var status=$('#statusses').val();
      $.getJSON('/_set_ticket_status', {
        team:"{{team}}", cve:"{{ticket['cve']['id']}}", system:"{{system}}", status:status
      }, function(data) {
        if(data["status"] == true){
          tStatus=status;
          $("#tickstatus").text(tStatus);
          $("#editStatus").prop('disabled', true);
          $("#statusses option[value='{{statusses[0]}}']").remove();
          setUpdate();
        }else{
          alert("an error occured");
        }
      })
    });
  })
</script>

<p>
  <b><span>{{ticket['cve']['id']}} - CVSS: {{ticket['cve']['cvss']}} - <span id="tickstatus">{{ticket['status']}}</span></span></b><br />
  <span>{{ticket['cve']['summary']}}</span>
</p>

<div class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">Notes <span id="edit-notes" class="glyphicon glyphicon-pencil" aria-hidden="true"></span></h3>
  </div>
  <div id="notes" class="panel-body">
    {{ticket["notes"]}}
  </div>
</div>

<div class="panel panel-info">
  <div class="panel-heading">
    <h3 class="panel-title">Actions</h3>
  </div>
  <div class="panel-body">
    <b>Set status</b><br />
    <select id="statusses">
      {% for s in statusses %}
        <option value="{{s}}">{{s}}</option>
      {% endfor %}
    </select>
    <button id="editStatus" disabled>Change status</button><br /><br />
    <b>Update requirements</b>
    <div id="update"></div>
  </div>
</div>

